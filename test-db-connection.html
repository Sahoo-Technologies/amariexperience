<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Connection Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">ðŸ”— Database Connection Test</h1>
        
        <div id="results" class="space-y-4 mb-8"></div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Test Database Operations</h2>
            
            <div class="space-y-4">
                <button onclick="testConnection()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Test Connection
                </button>
                <button onclick="testCreateTable()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Create Users Table
                </button>
                <button onclick="testInsertUser()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    Insert Test User
                </button>
                <button onclick="testSelectUsers()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                    Select Users
                </button>
            </div>
        </div>
    </div>

    <script>
        const NEON_URL = 'https://ep-misty-bush-ah51gttt-pooler.c-3.us-east-1.aws.neon.tech/sql';
        const NEON_TOKEN = 'npg_COWH0y3qtwUa';

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `p-4 rounded ${type === 'success' ? 'bg-green-100 text-green-800' : type === 'error' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            results.appendChild(div);
        }

        async function executeQuery(query, params = []) {
            try {
                console.log('Executing query:', query);
                console.log('With params:', params);
                
                const response = await fetch(NEON_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${NEON_TOKEN}`
                    },
                    body: JSON.stringify({ query, params })
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`Database query failed: ${response.status} ${response.statusText} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Response data:', result);
                return result;
            } catch (error) {
                console.error('Database error:', error);
                throw error;
            }
        }

        async function testConnection() {
            addResult('ðŸ”„ Testing database connection...', 'info');
            
            try {
                const result = await executeQuery('SELECT NOW() as current_time, version() as version');
                
                if (result && result.length > 0) {
                    addResult('âœ… Database connection successful!', 'success');
                    addResult(`ðŸ—„ï¸ Server time: ${result[0].current_time}`, 'info');
                    addResult(`ðŸ“Š PostgreSQL version: ${result[0].version}`, 'info');
                } else {
                    addResult('âŒ No response from database', 'error');
                }
            } catch (error) {
                addResult(`âŒ Connection failed: ${error.message}`, 'error');
                
                // Try alternative endpoint
                addResult('ðŸ”„ Trying alternative endpoint...', 'info');
                try {
                    const altResponse = await fetch('https://ep-misty-bush-ah51gttt-pooler.c-3.us-east-1.aws.neon.tech/v2/query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${NEON_TOKEN}`
                        },
                        body: JSON.stringify({ query: 'SELECT NOW() as current_time' })
                    });
                    
                    if (altResponse.ok) {
                        addResult('âœ… Alternative endpoint works!', 'success');
                    } else {
                        addResult('âŒ Alternative endpoint also failed', 'error');
                    }
                } catch (altError) {
                    addResult(`âŒ Alternative endpoint error: ${altError.message}`, 'error');
                }
            }
        }

        async function testCreateTable() {
            addResult('ðŸ”„ Creating users table...', 'info');
            
            try {
                const createTableQuery = `
                    CREATE TABLE IF NOT EXISTS users (
                        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                        email VARCHAR(255) UNIQUE NOT NULL,
                        first_name VARCHAR(100) NOT NULL,
                        last_name VARCHAR(100) NOT NULL,
                        phone VARCHAR(20),
                        user_type VARCHAR(20) NOT NULL DEFAULT 'couple',
                        password_hash VARCHAR(255) NOT NULL,
                        email_verified BOOLEAN DEFAULT FALSE,
                        is_active BOOLEAN DEFAULT TRUE,
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        last_login TIMESTAMP WITH TIME ZONE
                    );
                `;
                
                await executeQuery(createTableQuery);
                addResult('âœ… Users table created successfully!', 'success');
            } catch (error) {
                addResult(`âŒ Table creation failed: ${error.message}`, 'error');
            }
        }

        async function testInsertUser() {
            addResult('ðŸ”„ Inserting test user...', 'info');
            
            try {
                const testUser = {
                    email: 'test@example.com',
                    firstName: 'Test',
                    lastName: 'User',
                    phone: '+254712345678',
                    userType: 'couple',
                    password: 'TestPassword123'
                };
                
                // Hash password
                const hashedPassword = await hashPassword(testUser.password);
                
                const result = await executeQuery(`
                    INSERT INTO users (
                        email, first_name, last_name, phone, user_type, 
                        password_hash, email_verified, is_active
                    ) VALUES (
                        $1, $2, $3, $4, $5, $6, $7, $8
                    )
                    RETURNING id, email, first_name, last_name, created_at
                `, [
                    testUser.email,
                    testUser.firstName,
                    testUser.lastName,
                    testUser.phone,
                    testUser.userType,
                    hashedPassword,
                    true,
                    true
                ]);
                
                if (result && result.length > 0) {
                    addResult('âœ… Test user inserted successfully!', 'success');
                    addResult(`ðŸ“§ Email: ${result[0].email}`, 'info');
                    addResult(`ðŸ‘¤ Name: ${result[0].first_name} ${result[0].last_name}`, 'info');
                    addResult(`ðŸ†” ID: ${result[0].id}`, 'info');
                } else {
                    addResult('âŒ Failed to insert user', 'error');
                }
            } catch (error) {
                if (error.message.includes('duplicate key')) {
                    addResult('âš ï¸ User already exists (duplicate email)', 'error');
                } else {
                    addResult(`âŒ Insert failed: ${error.message}`, 'error');
                }
            }
        }

        async function testSelectUsers() {
            addResult('ðŸ”„ Selecting users...', 'info');
            
            try {
                const result = await executeQuery('SELECT id, email, first_name, last_name, user_type, created_at FROM users ORDER BY created_at DESC LIMIT 10');
                
                if (result && result.length > 0) {
                    addResult(`âœ… Found ${result.length} users!`, 'success');
                    result.forEach((user, index) => {
                        addResult(`${index + 1}. ${user.first_name} ${user.last_name} (${user.email}) - ${user.user_type}`, 'info');
                    });
                } else {
                    addResult('â„¹ï¸ No users found', 'info');
                }
            } catch (error) {
                addResult(`âŒ Select failed: ${error.message}`, 'error');
            }
        }

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Auto-test connection on load
        window.addEventListener('load', () => {
            setTimeout(testConnection, 1000);
        });
    </script>
</body>
</html>
