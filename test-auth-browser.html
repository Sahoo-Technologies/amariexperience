<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Auth Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">üß™ Neon Authentication Test</h1>
        
        <!-- Test Results -->
        <div id="results" class="space-y-4 mb-8"></div>
        
        <!-- Test Form -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Test Authentication</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="email" class="w-full border rounded px-3 py-2" value="test@example.com">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="password" class="w-full border rounded px-3 py-2" value="TestPassword123">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">First Name</label>
                    <input type="text" id="firstName" class="w-full border rounded px-3 py-2" value="Test">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Last Name</label>
                    <input type="text" id="lastName" class="w-full border rounded px-3 py-2" value="User">
                </div>
                
                <div class="flex gap-4">
                    <button onclick="testRegister()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Register User
                    </button>
                    <button onclick="testLogin()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        Login User
                    </button>
                    <button onclick="testLogout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        Logout
                    </button>
                    <button onclick="testProfile()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        Test Profile
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Database connection test
        const NEON_URL = 'https://ep-misty-bush-ah51gttt-pooler.c-3.us-east-1.aws.neon.tech/sql';
        const NEON_TOKEN = 'npg_COWH0y3qtwUa';

        async function executeQuery(query, params = []) {
            try {
                const response = await fetch(NEON_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${NEON_TOKEN}`
                    },
                    body: JSON.stringify({ query, params })
                });
                
                if (!response.ok) {
                    throw new Error(`Database query failed: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Database error:', error);
                throw error;
            }
        }

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `p-4 rounded ${type === 'success' ? 'bg-green-100 text-green-800' : type === 'error' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            results.appendChild(div);
        }

        async function testRegister() {
            addResult('üîÑ Testing user registration...', 'info');
            
            try {
                const hashedPassword = await hashPassword(document.getElementById('password').value);
                
                const result = await executeQuery(`
                    INSERT INTO users (
                        email, first_name, last_name, user_type, 
                        password_hash, email_verified, is_active
                    ) VALUES (
                        $1, $2, $3, $4, $5, $6, $7
                    )
                    RETURNING id, email, first_name, last_name, user_type, created_at
                `, [
                    document.getElementById('email').value,
                    document.getElementById('firstName').value,
                    document.getElementById('lastName').value,
                    'couple',
                    hashedPassword,
                    true,
                    true
                ]);

                if (result.length > 0) {
                    addResult('‚úÖ User registered successfully!', 'success');
                    addResult(`üìß Email: ${result[0].email}`, 'info');
                    addResult(`üë§ Name: ${result[0].first_name} ${result[0].last_name}`, 'info');
                    addResult(`üÜî ID: ${result[0].id}`, 'info');
                } else {
                    addResult('‚ùå Registration failed', 'error');
                }
            } catch (error) {
                addResult(`‚ùå Registration error: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            addResult('üîÑ Testing user login...', 'info');
            
            try {
                const result = await executeQuery(`
                    SELECT id, email, first_name, last_name, password_hash, user_type, created_at
                    FROM users 
                    WHERE email = $1 AND is_active = true
                `, [document.getElementById('email').value]);

                if (result.length > 0) {
                    const user = result[0];
                    const hashedPassword = await hashPassword(document.getElementById('password').value);
                    
                    // Simple password verification (in production, use proper comparison)
                    if (hashedPassword === user.password_hash) {
                        addResult('‚úÖ Login successful!', 'success');
                        addResult(`üë§ Welcome back, ${user.first_name}!`, 'info');
                        addResult(`üìÖ Member since: ${new Date(user.created_at).toLocaleDateString()}`, 'info');
                        
                        // Store in localStorage
                        localStorage.setItem('testUser', JSON.stringify(user));
                    } else {
                        addResult('‚ùå Invalid password', 'error');
                    }
                } else {
                    addResult('‚ùå User not found', 'error');
                }
            } catch (error) {
                addResult(`‚ùå Login error: ${error.message}`, 'error');
            }
        }

        function testLogout() {
            addResult('üîÑ Testing logout...', 'info');
            localStorage.removeItem('testUser');
            addResult('‚úÖ Logged out successfully!', 'success');
        }

        function testProfile() {
            addResult('üîÑ Testing profile access...', 'info');
            
            const user = localStorage.getItem('testUser');
            if (user) {
                const userData = JSON.parse(user);
                addResult('‚úÖ Profile accessible!', 'success');
                addResult(`üë§ Current user: ${userData.first_name} ${userData.last_name}`, 'info');
                addResult(`üìß Email: ${userData.email}`, 'info');
            } else {
                addResult('‚ùå No user logged in', 'error');
            }
        }

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Test database connection on load
        window.addEventListener('load', async () => {
            addResult('üîÑ Testing database connection...', 'info');
            
            try {
                const result = await executeQuery('SELECT NOW() as current_time');
                if (result.length > 0) {
                    addResult('‚úÖ Database connection successful!', 'success');
                    addResult(`üóÑÔ∏è Server time: ${result[0].current_time}`, 'info');
                } else {
                    addResult('‚ùå Database connection failed', 'error');
                }
            } catch (error) {
                addResult(`‚ùå Database error: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>
